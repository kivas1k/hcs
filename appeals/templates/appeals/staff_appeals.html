{% extends "base.html" %}

{% block title %}–û–±—Ä–∞—â–µ–Ω–∏—è ‚Äî –ñ–ö–• –°–µ—Ä–≤–∏—Å{% endblock %}

{% block content %}
<div class="auth-form">
  <div class="filter-header">
    <h2>–í—Å–µ –æ–±—Ä–∞—â–µ–Ω–∏—è</h2>
    <div class="filter-controls">
      <div class="dropdown">
        <button class="btn btn-primary">
          –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å
          <span class="dropdown-arrow"></span>
        </button>
        <div class="dropdown-menu">
          <a class="dropdown-item" href="?filter_type=title">–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é</a>
          <a class="dropdown-item" href="?filter_type=id">–ü–æ –Ω–æ–º–µ—Ä—É</a>
          <a class="dropdown-item" href="?filter_type=date">–ü–æ –¥–∞—Ç–µ</a>
          {% if current_filter %}
            <div class="dropdown-divider"></div>
            <a class="dropdown-item" href="?">–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä</a>
          {% endif %}
        </div>
      </div>
    </div>
    <div class="appeal-stats">
      <span class="stat-item">–í—Å–µ–≥–æ: {{ appeals_count }}</span>
    </div>
  </div>

  {% if appeals %}
    <div class="appeals-grid">
      {% for appeal in appeals %}
        <div class="appeal-card">
          <div class="card-top-controls">
            <div class="status-dropdown">
              <button class="status-btn">‚ñº –°—Ç–∞—Ç—É—Å —Ä–∞–±–æ—Ç—ã</button>
              <div class="status-menu">
                <form method="post" action="{% url 'appeals:staff_change_status' appeal.id 'free' %}">
                  {% csrf_token %}
                  <button type="submit" class="status-option">üü¢ –°–≤–æ–±–æ–¥–Ω–æ–µ</button>
                </form>
                <form method="post" action="{% url 'appeals:staff_change_status' appeal.id 'in_progress' %}">
                  {% csrf_token %}
                  <button type="submit" class="status-option">üü° –í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É</button>
                </form>
                <form method="post" action="{% url 'appeals:staff_change_status' appeal.id 'closed' %}">
                  {% csrf_token %}
                  <button type="submit" class="status-option">üî¥ –ó–∞–∫—Ä—ã—Ç—å –æ–±—Ä–∞—â–µ–Ω–∏–µ</button>
                </form>
              </div>
            </div>
            <a href="{% url 'appeals:staff_edit_appeal' appeal.id %}" class="tag-edit-btn small">
              ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
            </a>
          </div>

          <a href="{% url 'appeals:appeal_detail' appeal.id %}" class="card-content">
            <div class="card-header">
              <h3 class="card-title">{{ appeal.title|default:"–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è"|truncatechars:40 }}</h3>
              <span class="status-badge {{ appeal.status|default:'new' }}">
                {{ appeal.get_status_display|default:"–ù–æ–≤–æ–µ" }}
              </span>
            </div>

            <div class="card-meta">
              <div class="meta-item">
                <svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2L2 7l10 5 10-5-10-5M2 17l10 5 10-5M2 12l10 5 10-5"/></svg>
                –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: {{ appeal.get_priority_display|default:"–ù–µ —É–∫–∞–∑–∞–Ω" }}
              </div>
              <div class="meta-item">
                <svg width="16" height="16" viewBox="0 0 24 24"><path fill="currentColor" d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2m0 18c-4.4 0-8-3.6-8-8s3.6-8 8-8 8 3.6 8 8-3.6 8-8 8m-1-13h2v6h-2V7m0 8h2v2h-2v-2"/></svg>
                {{ appeal.created_at|date:"d.m.Y H:i"|default:"–î–∞—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞" }}
              </div>
            </div>

            <div class="card-tags">
              {% for tag in appeal.tags.all %}
                <span class="tag">{{ tag.name }}</span>
              {% empty %}
                <span class="tag">–ù–µ—Ç —Ç–µ–≥–æ–≤</span>
              {% endfor %}

              <div class="employee-status">
                <span class="status-tag {{ appeal.employee_status }}">
                  {{ appeal.get_employee_status_display }}
                  {% if appeal.employee_status == 'in_progress' and appeal.taken_by %}
                    ({{ appeal.taken_by.username }})
                  {% elif appeal.employee_status == 'closed' and appeal.closed_by %}
                    ({{ appeal.closed_by.username }})
                  {% endif %}
                </span>
              </div>
            </div>
          </a>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="empty-state">
      <div class="empty-icon">üì≠</div>
      <h3>{% if current_filter %}–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ{% else %}–û–±—Ä–∞—â–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç{% endif %}</h3>
      <p>{% if current_filter %}–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Ñ–∏–ª—å—Ç—Ä–∞{% else %}–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –æ–±—Ä–∞—â–µ–Ω–∏–π{% endif %}</p>
    </div>
  {% endif %}
</div>

<style>
.appeals-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
  gap: 2rem;
  margin-top: 2rem;
}

.appeal-card {
  background: white;
  border-radius: 12px;
  box-shadow: 0 3px 15px rgba(0, 168, 107, 0.1);
  transition: all 0.3s ease;
  padding: 2rem;
  display: flex;
  flex-direction: column;
  gap: 1rem;
  min-height: 280px;
}

.appeal-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 25px rgba(0, 168, 107, 0.15);
}

.card-content {
  text-decoration: none;
  color: inherit;
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.card-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  margin-top: 1rem;
}

.tag {
  background: #e0f5eb;
  color: var(--dark);
  padding: 0.4rem 1rem;
  border-radius: 20px;
  font-size: 0.85rem;
}

.employee-status {
  margin-top: 0.5rem;
  width: 100%;
}

.status-tag {
  display: inline-block;
  padding: 0.4rem 1rem;
  border-radius: 20px;
  font-size: 0.85rem;
  font-weight: 500;
}

.status-tag.free { background: #d4edda; color: #0f5132; }
.status-tag.in_progress { background: #fff3cd; color: #856404; }
.status-tag.closed { background: #f8d7da; color: #842029; }

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 1rem;
}

.card-title {
  margin: 0;
  font-size: 1.25rem;
  font-weight: bold;
}

.status-badge {
  padding: 0.4rem 0.8rem;
  border-radius: 20px;
  font-size: 0.85rem;
}

.status-badge.new {
  background: #fff3cd;
  color: #856404;
}

.card-meta {
  display: flex;
  flex-wrap: wrap;
  gap: 1rem;
  font-size: 0.9rem;
}

.meta-item {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.card-top-controls {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.status-dropdown {
  position: relative;
}

.status-btn {
  padding: 0.4rem 0.8rem;
  background: #f8f9fa;
  border: 2px solid #dee2e6;
  border-radius: 6px;
  font-size: 0.85rem;
  cursor: pointer;
}

.status-menu {
  display: none;
  position: absolute;
  top: 110%;
  right: 0;
  background: white;
  box-shadow: 0 3px 15px rgba(0,0,0,0.1);
  border-radius: 8px;
  min-width: 180px;
  padding: 0.5rem;
  z-index: 10;
}

.status-option {
  width: 100%;
  padding: 0.6rem 1rem;
  background: none;
  border: none;
  text-align: left;
  font-size: 0.85rem;
  cursor: pointer;
}

.status-option:hover {
  background: #f8f9fa;
}

.tag-edit-btn.small {
  font-size: 0.75rem;
  padding: 0.3rem 0.6rem;
  background: var(--primary);
  color: white;
  border-radius: 6px;
  text-decoration: none;
}

.tag-edit-btn.small:hover {
  background: var(--secondary);
}
</style>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const dropdowns = document.querySelectorAll('.dropdown');

  dropdowns.forEach(dropdown => {
    const menu = dropdown.querySelector('.dropdown-menu');
    let timeoutId;

    dropdown.addEventListener('mouseenter', () => {
      clearTimeout(timeoutId);
      menu.style.display = 'block';
    });

    dropdown.addEventListener('mouseleave', () => {
      timeoutId = setTimeout(() => {
        menu.style.display = 'none';
      }, 300);
    });

    menu.addEventListener('mouseenter', () => clearTimeout(timeoutId));
    menu.addEventListener('mouseleave', () => {
      timeoutId = setTimeout(() => {
        menu.style.display = 'none';
      }, 300);
    });
  });

  const statusDropdowns = document.querySelectorAll('.status-dropdown');

  statusDropdowns.forEach(dropdown => {
    const menu = dropdown.querySelector('.status-menu');
    let timeoutId;

    dropdown.addEventListener('mouseenter', () => {
      clearTimeout(timeoutId);
      menu.style.display = 'block';
    });

    dropdown.addEventListener('mouseleave', () => {
      timeoutId = setTimeout(() => {
        menu.style.display = 'none';
      }, 300);
    });

    menu.addEventListener('mouseenter', () => clearTimeout(timeoutId));
    menu.addEventListener('mouseleave', () => {
      timeoutId = setTimeout(() => {
        menu.style.display = 'none';
      }, 300);
    });
  });
});
</script>
{% endblock %}
